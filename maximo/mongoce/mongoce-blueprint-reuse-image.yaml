apiVersion: cr.kanister.io/v1alpha1
kind: Blueprint
metadata:
  name: mongoce-blueprint
  namespace: kasten-io
  annotations:
    category: database
    description: Blueprint to backup and restore MongoDB used by Maximo Application Suite
actions:
  
  preBackupHook:    
    phases:
    - func: KubeTask
      name: backupDiscovery
      args:
        # https://github.com/michaelcourcy/kasten-tools
        image: michaelcourcy/kasten-tools:8.0.8
        command:
        - sh
        - -cx
        - |
          NAMESPACE={{ .Namespace.Name }}

          echo "discovering the key inside mas-mongo-ce-ca-certificate and mas-mongo-ce-server-certificate-key"
          ca_key=$(kubectl get secret mas-mongo-ce-ca-certificate -n $NAMESPACE -o jsonpath='{.data}' | jq -r 'keys[0]')
          server_key=$(kubectl get secret mas-mongo-ce-server-certificate-key -n $NAMESPACE -o jsonpath='{.data}' | jq -r 'keys[0]')
          kando output ca_key $ca_key
          kando output server_key $server_key

          echo "Discovering the image used in the statefulset"
          image=$(kubectl get statefulset mas-mongo-ce -n $NAMESPACE -o jsonpath='{.spec.template.spec.containers[?(@.name=="mongod")].image}')
          kando output image $image

          # we need to find a way to discover the MAS_INSTANCE_ID
          # always make sure you created the configmap mas-instance-id in the mongoce namespace
          # oc create configmap -n mongoce mas-instance-id --from-literal mas-instance-id=dev
          if [ -z "$(kubectl get configmap -n $NAMESPACE mas-instance-id --ignore-not-found=true)" ]; then
            echo "configmap mas-instance-id not found in namespace $NAMESPACE, please create it with the MAS_INSTANCE_ID (e.g., oc create configmap -n $NAMESPACE mas-instance-id --from-literal mas-instance-id=dev)"
            exit 1
          fi
          mas_instance_id=$(kubectl get configmap -n $NAMESPACE mas-instance-id -o jsonpath='{.data.mas-instance-id}')
          kando output mas_instance_id $mas_instance_id

          # if the pod and the pvc are already there, delete them to start fresh
          kubectl delete pod mongoce-backup -n $NAMESPACE --ignore-not-found=true
          kubectl delete pvc mongoce-backup-pvc -n $NAMESPACE --ignore-not-found=true

    - func: KubeOps
      name: createMongoBackupPod
      args:
        operation: create
        namespace: "{{ .Namespace.Name }}"
        spec: |-
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: mongoce-backup-pvc            
          spec:
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 20Gi
          ---
          apiVersion: v1
          kind: Pod
          metadata:
            name: mongoce-backup            
            labels:
              app: mongoce-backup
          spec:
            securityContext: 
              runAsUser: 2000
              runAsNonRoot: true
              fsGroup: 2000
            containers:
            - name: mongoce-backup
              image: {{ .Phases.backupDiscovery.Output.image }}
              command: ["/bin/bash", "-c", "while true; do sleep 30; done"]
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop:
                  - ALL                
              env:
              - name: MONGO_ADMIN_PASSWORD
                valueFrom:
                  secretKeyRef:
                    name: mas-mongo-ce-admin-admin
                    key: password        
              volumeMounts:
              - name: tls-ca
                mountPath: /var/lib/tls/ca
                readOnly: true
              - name: tls-secret
                mountPath: /var/lib/tls/server
                readOnly: true
              - name: backup-storage
                mountPath: /k10-dumps/mongoce
            volumes:
            - name: tls-ca
              secret:
                secretName: mas-mongo-ce-ca-certificate
                items:
                  - key: {{ .Phases.backupDiscovery.Output.ca_key }}
                    path: ca.crt
            - name: tls-secret
              secret:
                secretName: mas-mongo-ce-server-certificate-key
                items:
                  - key: {{ .Phases.backupDiscovery.Output.server_key }}
                    path: mongo.pem
            - name: backup-storage
              persistentVolumeClaim:
                claimName: mongoce-backup-pvc            
            restartPolicy: Never
    - func: WaitV2
      name: waitForMongoceBackupPodReady
      args:
        timeout: 5m
        conditions:
          anyOf:
          - condition: '{{ $available := false }}{{ range $condition := $.status.conditions }}{{ if and (eq .type "Ready") (eq .status "True") }}{{ $available = true }}{{ end }}{{ end }}{{ $available }}'
            objectReference:
              apiVersion: "v1"
              group: ""
              name: mongoce-backup
              namespace: "{{ .Namespace.Name }}"
              resource: "pods"
    - func: KubeExec
      name: createDumps
      args:
        namespace: "{{ .Namespace.Name }}"
        pod: mongoce-backup
        container: mongoce-backup
        command:
          - bash
          - -o
          - errexit
          - -o
          - pipefail
          - -c
          - |
            NAMESPACE={{ .Namespace.Name }}
            cd /k10-dumps/mongoce

            # MAS_INSTANCE_ID can be a comma-separated list (e.g., "sbx,uat,prod")
            MAS_INSTANCE_IDS="{{ .Phases.backupDiscovery.Output.mas_instance_id }}"
            
            # Convert comma-separated list to array
            IFS=',' read -ra INSTANCE_ARRAY <<< "$MAS_INSTANCE_IDS"
            
            # Loop through each instance ID
            for MAS_INSTANCE_ID in "${INSTANCE_ARRAY[@]}"; do
              # Trim whitespace
              MAS_INSTANCE_ID=$(echo "$MAS_INSTANCE_ID" | xargs)
              
              echo "Starting mongodump for mas_${MAS_INSTANCE_ID}_core"
              mongodump --uri="mongodb://admin:$MONGO_ADMIN_PASSWORD@mas-mongo-ce-0.mas-mongo-ce-svc.$NAMESPACE.svc.cluster.local:27017,mas-mongo-ce-1.mas-mongo-ce-svc.$NAMESPACE.svc.cluster.local:27017,mas-mongo-ce-2.mas-mongo-ce-svc.$NAMESPACE.svc.cluster.local:27017/?replicaSet=mas-mongo-ce&tls=true&authSource=admin" --sslCAFile=/var/lib/tls/ca/ca.crt --archive=/k10-dumps/mongoce/mas_${MAS_INSTANCE_ID}_core.archive -d mas_${MAS_INSTANCE_ID}_core
              echo "Completed mongodump for mas_${MAS_INSTANCE_ID}_core"
              
              echo "Starting mongodump for mas_${MAS_INSTANCE_ID}_catalog"
              mongodump --uri="mongodb://admin:$MONGO_ADMIN_PASSWORD@mas-mongo-ce-0.mas-mongo-ce-svc.$NAMESPACE.svc.cluster.local:27017,mas-mongo-ce-1.mas-mongo-ce-svc.$NAMESPACE.svc.cluster.local:27017,mas-mongo-ce-2.mas-mongo-ce-svc.$NAMESPACE.svc.cluster.local:27017/?replicaSet=mas-mongo-ce&tls=true&authSource=admin" --sslCAFile=/var/lib/tls/ca/ca.crt --archive=/k10-dumps/mongoce/mas_${MAS_INSTANCE_ID}_catalog.archive -d mas_${MAS_INSTANCE_ID}_catalog
              echo "Completed mongodump for mas_${MAS_INSTANCE_ID}_catalog"
            done
  
  postBackupHook:
    phases:
    - func: KubeOps
      name: deleteMongoBackupPod
      args:
        operation: delete
        objectReference:
          apiVersion: v1
          group: ""
          resource: "pods"
          name: "mongoce-backup"
          namespace: "{{ .Namespace.Name }}"
    - func: KubeOps
      name: deleteMongoBackupPVC
      args:
        operation: delete
        objectReference:
          apiVersion: v1
          group: ""
          resource: "persistentvolumeclaims"
          name: "mongoce-backup-pvc"
          namespace: "{{ .Namespace.Name }}"

  postRestoreHook:    
    phases:
    - func: KubeTask
      name: restoreDiscovery
      args:
        # https://github.com/michaelcourcy/kasten-tools
        image: michaelcourcy/kasten-tools:8.0.8
        command:
        - sh
        - -cx
        - |
          NAMESPACE={{ .Namespace.Name }}

          echo "discovering the key inside mas-mongo-ce-ca-certificate and mas-mongo-ce-server-certificate-key"
          ca_key=$(kubectl get secret mas-mongo-ce-ca-certificate -n $NAMESPACE -o jsonpath='{.data}' | jq -r 'keys[0]')
          server_key=$(kubectl get secret mas-mongo-ce-server-certificate-key -n $NAMESPACE -o jsonpath='{.data}' | jq -r 'keys[0]')
          kando output ca_key $ca_key
          kando output server_key $server_key

          echo "Discovering the image used in the statefulset"
          image=$(kubectl get statefulset mas-mongo-ce -n $NAMESPACE -o jsonpath='{.spec.template.spec.containers[?(@.name=="mongod")].image}')
          kando output image $image

          # we need to find a way to discover the MAS_INSTANCE_ID
          # always make sure you created the configmap mas-instance-id in the mongoce namespace
          # oc create configmap -n mongoce mas-instance-id --from-literal mas-instance-id=dev
          if [ -z "$(kubectl get configmap -n $NAMESPACE mas-instance-id --ignore-not-found=true)" ]; then
            echo "configmap mas-instance-id not found in namespace $NAMESPACE, please create it with the MAS_INSTANCE_ID (e.g., oc create configmap -n $NAMESPACE mas-instance-id --from-literal mas-instance-id=dev)"
            exit 1
          fi
          mas_instance_id=$(kubectl get configmap -n $NAMESPACE mas-instance-id -o jsonpath='{.data.mas-instance-id}')
          kando output mas_instance_id $mas_instance_id
    # we don't need to recreate pvc as it is restored by kasten, the pod need to be recreated with the key that may have changed on another cluster or another time
    - func: KubeOps
      name: createMongoRestorePod
      args:
        operation: create
        namespace: "{{ .Namespace.Name }}"
        spec: |-          
          apiVersion: v1
          kind: Pod
          metadata:
            name: mongoce-backup            
            labels:
              app: mongoce-backup
          spec:
            securityContext: 
              runAsUser: 2000
              runAsNonRoot: true
              fsGroup: 2000
            containers:
            - name: mongoce-backup
              image: {{ .Phases.restoreDiscovery.Output.image }}
              command: ["/bin/bash", "-c", "while true; do sleep 30; done"]
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop:
                  - ALL           
              env:
              - name: MONGO_ADMIN_PASSWORD
                valueFrom:
                  secretKeyRef:
                    name: mas-mongo-ce-admin-admin
                    key: password        
              volumeMounts:
              - name: tls-ca
                mountPath: /var/lib/tls/ca
                readOnly: true
              - name: tls-secret
                mountPath: /var/lib/tls/server
                readOnly: true
              - name: backup-storage
                mountPath: /k10-dumps/mongoce
            volumes:
            - name: tls-ca
              secret:
                secretName: mas-mongo-ce-ca-certificate
                items:
                  - key: {{ .Phases.restoreDiscovery.Output.ca_key }}
                    path: ca.crt
            - name: tls-secret
              secret:
                secretName: mas-mongo-ce-server-certificate-key
                items:
                  - key: {{ .Phases.restoreDiscovery.Output.server_key }}
                    path: mongo.pem
            - name: backup-storage
              persistentVolumeClaim:
                claimName: mongoce-backup-pvc            
            restartPolicy: Never
    - func: WaitV2
      name: waitForMongoceRestorePodReady
      args:
        timeout: 5m
        conditions:
          anyOf:
          - condition: '{{ $available := false }}{{ range $condition := $.status.conditions }}{{ if and (eq .type "Ready") (eq .status "True") }}{{ $available = true }}{{ end }}{{ end }}{{ $available }}'
            objectReference:
              apiVersion: "v1"
              group: ""
              name: mongoce-backup
              namespace: "{{ .Namespace.Name }}"
              resource: "pods"
    - func: KubeExec
      name: restoreDumps
      args:
        namespace: "{{ .Namespace.Name }}"
        pod: mongoce-backup
        container: mongoce-backup
        command:
          - bash
          - -o
          - errexit
          - -o
          - pipefail
          - -c
          - |
            NAMESPACE={{ .Namespace.Name }}
            cd /k10-dumps/mongoce

            # MAS_INSTANCE_ID can be a comma-separated list (e.g., "sbx,uat,prod")
            MAS_INSTANCE_IDS="{{ .Phases.restoreDiscovery.Output.mas_instance_id }}"
            
            # Convert comma-separated list to array
            IFS=',' read -ra INSTANCE_ARRAY <<< "$MAS_INSTANCE_IDS"
            
            # Loop through each instance ID
            for MAS_INSTANCE_ID in "${INSTANCE_ARRAY[@]}"; do
              # Trim whitespace
              MAS_INSTANCE_ID=$(echo "$MAS_INSTANCE_ID" | xargs)
              echo "Backing up the OauthClient collection in database mas_${MAS_INSTANCE_ID}_core as it contains client secrets that should not be overwritten during restore"
              mongodump --uri="mongodb://admin:$MONGO_ADMIN_PASSWORD@mas-mongo-ce-0.mas-mongo-ce-svc.$NAMESPACE.svc.cluster.local:27017,mas-mongo-ce-1.mas-mongo-ce-svc.$NAMESPACE.svc.cluster.local:27017,mas-mongo-ce-2.mas-mongo-ce-svc.$NAMESPACE.svc.cluster.local:27017/?replicaSet=mas-mongo-ce&tls=true&authSource=admin" --sslCAFile=/var/lib/tls/ca/ca.crt --archive=/k10-dumps/mongoce/mas_${MAS_INSTANCE_ID}_core_oauthclient.archive -d mas_${MAS_INSTANCE_ID}_core --collection OauthClient
                            
              echo "Dropping database mas_${MAS_INSTANCE_ID}_core before restore"
              mongosh "mongodb://admin:$MONGO_ADMIN_PASSWORD@mas-mongo-ce-0.mas-mongo-ce-svc.$NAMESPACE.svc.cluster.local:27017,mas-mongo-ce-1.mas-mongo-ce-svc.$NAMESPACE.svc.cluster.local:27017,mas-mongo-ce-2.mas-mongo-ce-svc.$NAMESPACE.svc.cluster.local:27017/?replicaSet=mas-mongo-ce&tls=true&authSource=admin" --tls --tlsCAFile /var/lib/tls/ca/ca.crt --eval "db.getSiblingDB('mas_${MAS_INSTANCE_ID}_core').dropDatabase()" 

              echo "Starting restore for mas_${MAS_INSTANCE_ID}_core except OauthClient collection"
              mongorestore --uri="mongodb://admin:$MONGO_ADMIN_PASSWORD@mas-mongo-ce-0.mas-mongo-ce-svc.$NAMESPACE.svc.cluster.local:27017,mas-mongo-ce-1.mas-mongo-ce-svc.$NAMESPACE.svc.cluster.local:27017,mas-mongo-ce-2.mas-mongo-ce-svc.$NAMESPACE.svc.cluster.local:27017/?replicaSet=mas-mongo-ce&tls=true&authSource=admin" --sslCAFile=/var/lib/tls/ca/ca.crt --archive=/k10-dumps/mongoce/mas_${MAS_INSTANCE_ID}_core.archive  --nsExclude=mas_${MAS_INSTANCE_ID}_core.OauthClient
              
              echo "Restoring OauthClient collection for mas_${MAS_INSTANCE_ID}_core from the previously backed up oauthclient collection"
              mongorestore --uri="mongodb://admin:$MONGO_ADMIN_PASSWORD@mas-mongo-ce-0.mas-mongo-ce-svc.$NAMESPACE.svc.cluster.local:27017,mas-mongo-ce-1.mas-mongo-ce-svc.$NAMESPACE.svc.cluster.local:27017,mas-mongo-ce-2.mas-mongo-ce-svc.$NAMESPACE.svc.cluster.local:27017/?replicaSet=mas-mongo-ce&tls=true&authSource=admin" --sslCAFile=/var/lib/tls/ca/ca.crt --archive=/k10-dumps/mongoce/mas_${MAS_INSTANCE_ID}_core_oauthclient.archive  
              
              echo "Dropping database mas_${MAS_INSTANCE_ID}_catalog before restore"
              mongosh "mongodb://admin:$MONGO_ADMIN_PASSWORD@mas-mongo-ce-0.mas-mongo-ce-svc.$NAMESPACE.svc.cluster.local:27017,mas-mongo-ce-1.mas-mongo-ce-svc.$NAMESPACE.svc.cluster.local:27017,mas-mongo-ce-2.mas-mongo-ce-svc.$NAMESPACE.svc.cluster.local:27017/?replicaSet=mas-mongo-ce&tls=true&authSource=admin" --tls --tlsCAFile /var/lib/tls/ca/ca.crt --eval "db.getSiblingDB('mas_${MAS_INSTANCE_ID}_catalog').dropDatabase()"
              
              echo "Starting restore for mas_${MAS_INSTANCE_ID}_catalog"
              mongorestore --uri="mongodb://admin:$MONGO_ADMIN_PASSWORD@mas-mongo-ce-0.mas-mongo-ce-svc.$NAMESPACE.svc.cluster.local:27017,mas-mongo-ce-1.mas-mongo-ce-svc.$NAMESPACE.svc.cluster.local:27017,mas-mongo-ce-2.mas-mongo-ce-svc.$NAMESPACE.svc.cluster.local:27017/?replicaSet=mas-mongo-ce&tls=true&authSource=admin" --sslCAFile=/var/lib/tls/ca/ca.crt --archive=/k10-dumps/mongoce/mas_${MAS_INSTANCE_ID}_catalog.archive
              echo "Completed restore for mas_${MAS_INSTANCE_ID}_catalog"
            done
    # clean up
    - func: KubeOps
      name: deleteMongoBackupPodAfterRestore
      args:
        operation: delete
        objectReference:
          apiVersion: v1
          group: ""
          resource: "pods"
          name: "mongoce-backup"
          namespace: "{{ .Namespace.Name }}"
    - func: KubeOps
      name: deleteMongoBackupPVCAfterRestore
      args:
        operation: delete
        objectReference:
          apiVersion: v1
          group: ""
          resource: "persistentvolumeclaims"
          name: "mongoce-backup-pvc"
          namespace: "{{ .Namespace.Name }}"
  
  postRestoreHookError:
    phases:
    - func: KubeOps
      name: deleteMongoBackupPodAfterRestoreError
      args:
        operation: delete
        objectReference:
          apiVersion: v1
          group: ""
          resource: "pods"
          name: "mongoce-backup"
          namespace: "{{ .Namespace.Name }}"
    - func: KubeOps
      name: deleteMongoBackupPVCAfterRestoreError
      args:
        operation: delete
        objectReference:
          apiVersion: v1
          group: ""
          resource: "persistentvolumeclaims"
          name: "mongoce-backup-pvc"
          namespace: "{{ .Namespace.Name }}"